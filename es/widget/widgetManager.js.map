{"version":3,"file":"widgetManager.js","sourceRoot":"","sources":["../../src/widget/widgetManager.ts"],"names":[],"mappings":"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","sourcesContent":["import {connectToChild} from 'penpal';\n\nimport {IConfig, IMethods, IWidget, SignWrapped} from '../types';\nimport {AccountModel} from '@emit-technology/emit-lib';\nimport {onWindowLoad, validateSecureOrigin} from '../utils';\nimport {styles} from './styles';\nimport {ChainType} from \"@emit-technology/emit-lib\";\n\n// Create a .env file to override the default WIDGET_URL when running locally\nconst EMIT_WIDGET_URL = process.env.EMIT_WIDGET_URL || 'https://accounts.emit.technology/#/widget';\nconst EMIT_CONTAINER_CLASS = 'emit-widget-container';\nconst EMIT_IFRAME_CLASS = 'emit-widget-frame';\n\nexport function windowLoadHandler() {\n    if (document.getElementsByClassName(EMIT_CONTAINER_CLASS).length) {\n        console.warn(\n            'EMIT script was already loaded. This might cause unexpected behavior. If loading with a script tag, please make sure that you only load it once.',\n        );\n    }\n}\n\nexport class WidgetManager {\n    private widgetPromise?: Promise<IWidget>;\n    private widgetInstance?: IWidget;\n    private _widgetUrl = EMIT_WIDGET_URL;\n    private _onActiveWalletChangedCallback?: (walletAddress: string) => void;\n    private _onActiveAccountChangedCallback?: (account: AccountModel) => void;\n    private _onErrorCallback: (error: Error) => void = () => {\n    };\n\n    constructor(private _widgetConfig: IConfig) {\n        validateSecureOrigin();\n        WidgetManager._checkIfWidgetAlreadyInitialized();\n    }\n\n    // async singleton\n    async getWidget() {\n        if (!this.widgetInstance) {\n            if (!this.widgetPromise) {\n                this.widgetPromise = this._initWidget();\n            }\n            this.widgetInstance = await this.widgetPromise;\n        }\n        return this.widgetInstance;\n    }\n\n    // Population by the dev of SDK callbacks that might be invoked by the widget\n\n    setOnActiveWalletChangedCallback(callback: (walletAddress: string) => void) {\n        this._onActiveWalletChangedCallback = callback;\n    }\n\n    setOnActiveAccountChangedCallback(callback: (account: AccountModel) => void) {\n        this._onActiveAccountChangedCallback = callback;\n    }\n\n    setOnErrorCallback(callback: (error: Error) => void) {\n        this._onErrorCallback = callback;\n    }\n\n    // SDK methods that could be invoked by the user and handled by the widget\n\n    async showWidget() {\n        const widgetCommunication = (await this.getWidget()).communication;\n        return widgetCommunication.showWidget(this._widgetConfig);\n    }\n\n    async requestAccount(accountId?:string) {\n        const widgetCommunication = (await this.getWidget()).communication;\n        return widgetCommunication.requestAccount(this._widgetConfig,accountId);\n    }\n\n    async setLanguage(code:string) {\n        const widgetCommunication = (await this.getWidget()).communication;\n        return widgetCommunication.setLanguage(code);\n    }\n\n    async calcGasPrice(gasLimitHex:string,chain:ChainType) {\n        const widgetCommunication = (await this.getWidget()).communication;\n        return widgetCommunication.calcGasPrice(gasLimitHex,chain,this._widgetConfig);\n    }\n    async batchSignMsg(signArr: Array<SignWrapped>): Promise<Array<SignWrapped>> {\n        const widgetCommunication = (await this.getWidget()).communication;\n        const {error, result} = await widgetCommunication.batchSignMessage(this._widgetConfig,signArr)\n        if (error) {\n            return []\n        }\n        return result;\n    }\n\n    // internal methods\n\n    private static _checkIfWidgetAlreadyInitialized() {\n        if (document.getElementsByClassName(EMIT_CONTAINER_CLASS).length) {\n            console.warn(\n                'An instance of EMIT was already initialized. This is probably a mistake. Make sure that you use the same EMIT instance throughout your app.',\n            );\n        }\n    }\n\n    private async _initWidget(): Promise<IWidget> {\n        await onWindowLoad();\n\n        const style = document.createElement('style');\n        style.innerHTML = styles;\n\n        const container = document.createElement('div');\n        container.className = EMIT_CONTAINER_CLASS;\n\n        const widgetFrame = document.createElement('div');\n        widgetFrame.id = `emit-container-${Date.now()}`;\n        widgetFrame.className = EMIT_IFRAME_CLASS;\n\n        // const widgetTitle = document.createElement('div');\n        // widgetTitle.className = 'emit-widget-title';\n        // widgetTitle.innerHTML = 'powered by emit';\n\n        // const widgetUrl = document.createElement('div');\n        // widgetUrl.className = 'emit-widget-url';\n        // widgetUrl.innerHTML = this._widgetUrl;\n\n        // const closeBtm = document.createElement('div');\n        // closeBtm.className = 'close-btn';\n        // closeBtm.innerHTML = \"x\";\n        // closeBtm.addEventListener('click', ev => {\n        //     this._setHeight(0);\n        // })\n\n        const iframe = document.createElement('iframe');\n        console.log(\"init...\", this._widgetUrl, this);\n        iframe.src = this._widgetUrl;\n        iframe.style.position = 'absolute';\n        iframe.style.height = '100%';\n        iframe.style.width = '100%';\n        iframe.style.border = '0 transparent';\n\n        // This conditional is not Penpal-specific. It's merely\n        // an example of how you can add an iframe to the document.\n        if (\n            document.readyState === 'complete' ||\n            document.readyState === 'interactive'\n        ) {\n            // widgetTitle.appendChild(closeBtm);\n            // widgetFrame.appendChild(widgetTitle);\n            // widgetFrame.appendChild(widgetUrl);\n            widgetFrame.appendChild(iframe);\n            container.appendChild(widgetFrame);\n            document.body.appendChild(container);\n            document.head.appendChild(style);\n        } else {\n            document.addEventListener('DOMContentLoaded', () => {\n                widgetFrame.appendChild(iframe);\n                container.appendChild(widgetFrame);\n                document.body.appendChild(container);\n                document.head.appendChild(style);\n            });\n        }\n\n        const connection = connectToChild<IMethods>({\n            iframe: iframe,\n            methods: {\n                setHeight: this._setHeight.bind(this),\n                getWindowSize: WidgetManager._getWindowSize.bind(this),\n                onActiveWalletChanged: this._onActiveWalletChanged.bind(this),\n                onActiveAccountChanged: this._onActiveAccountChanged.bind(this),\n                hasOnActiveWalletChanged: this.hasOnActiveWalletChanged.bind(this),\n                onError: this._onError.bind(this),\n            },\n        });\n\n        const communication = await connection.promise;\n        await communication.setConfig(this._widgetConfig);\n\n        return {communication, widgetFrame};\n    }\n\n    private async _setHeight(height?: string) {\n        const widgetFrame = (await this.getWidget()).widgetFrame;\n        if(height){\n            widgetFrame.style.height = height;\n            widgetFrame.style.width = `100%` ;\n        }else{\n            widgetFrame.style.height = '0';\n            widgetFrame.style.width =  '0';\n        }\n    }\n\n    private static _getWindowSize() {\n        const body = document.getElementsByTagName('body')[0];\n        const width = window.innerWidth || document.documentElement.clientWidth || body.clientWidth;\n        const height = window.innerHeight || document.documentElement.clientHeight || body.clientHeight;\n        return {width, height};\n    }\n\n    private _onActiveWalletChanged(walletAddress: string) {\n        if (this._onActiveWalletChangedCallback) {\n            this._onActiveWalletChangedCallback(walletAddress);\n        }\n    }\n\n    private _onActiveAccountChanged(account: AccountModel) {\n        if (this._onActiveAccountChangedCallback) {\n            this._onActiveAccountChangedCallback(account);\n        }\n    }\n\n    private hasOnActiveWalletChanged(): boolean {\n        return !!this._onActiveWalletChangedCallback;\n    }\n\n    private _onError(error: Error) {\n        if (this._onErrorCallback) {\n            this._onErrorCallback(error);\n        }\n    }\n}\n"]}